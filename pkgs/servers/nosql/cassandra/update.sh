#!/usr/bin/env nix-shell
#!nix-shell -i bash
#!nix-shell -p git

cd "$(dirname "$0")"
set -eux -o pipefail

tmp="$(mktemp -d)"
cleanup() {
  rm -rf "$tmp"
}
trap cleanup EXIT

# get numeric-only versions, sort them latest first
git ls-remote --tags https://github.com/apache/cassandra \
  | awk '{ if (match($0, /refs.tags.cassandra-([0-9.]*)$/, m)) print m[1] }' \
  | sort -V \
  | tac >$tmp/versions

version="$(grep -E '3[.]11[.]' <$tmp/versions | head -n 1)"
hash="$(nix-prefetch-url "mirror://apache/cassandra/${version}/apache-cassandra-${version}-bin.tar.gz")"
cat >3.11.nix <<EOF
# GENERATED BY update.sh
{ callPackage, ... } @ args:
callPackage ./generic.nix (args // {
  version = "$version";
  sha256 = "$hash";
  generation = "3_11";
})
EOF

version="$(grep -E '3[.]0[.]' <$tmp/versions | head -n 1)"
hash="$(nix-prefetch-url "mirror://apache/cassandra/${version}/apache-cassandra-${version}-bin.tar.gz")"
cat >3.0.nix <<EOF
# GENERATED BY update.sh
{ callPackage, ... } @ args:
callPackage ./generic.nix (args // {
  version = "$version";
  sha256 = "$hash";
  generation = "3_0";
})
EOF
